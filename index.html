<!doctype html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Neon Abyss</title>

<link rel="icon" type="image/png" href="./assets/neon-abyss-floor.png">
<link rel="apple-touch-icon" href="./assets/neon-abyss-floor.png">

<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.3/pixi.min.js"></script>

<style>
body{
  margin:0;
  overflow:hidden;
  background:#000;
  touch-action:none;
}
canvas{ display:block; }
</style>
</head>
<body>

<script>
(async () => {

// ================= APP =================
const app = new PIXI.Application({
  resizeTo: window,
  backgroundColor: 0x000000,
  antialias: true
});
document.body.appendChild(app.view);

// ================= PRELOAD =================
await PIXI.Assets.load([
  "./assets/station_bg.png",
  "./assets/ship.png"
]);

// ================= BACKGROUND =================
const skyline = PIXI.Sprite.from("./assets/station_bg.png");
skyline.anchor.set(0.5);

function updateSkyline(){
  const scale = Math.max(
    app.screen.width / skyline.texture.width,
    app.screen.height / skyline.texture.height
  );
  skyline.scale.set(scale);
  skyline.position.set(app.screen.width/2, app.screen.height/2);
}

updateSkyline();
skyline.alpha = 0.6;
app.stage.addChild(skyline);

// ================= CAMERA =================
const camera = new PIXI.Container();
app.stage.addChild(camera);

const groundLayer = new PIXI.Container();
const buildingLayer = new PIXI.Container();
const rainLayer = new PIXI.Container();

buildingLayer.sortableChildren = true;

camera.addChild(groundLayer);
camera.addChild(buildingLayer);
app.stage.addChild(rainLayer);

// ================= ISO MAP =================
function cartToIso(x,y){
  return {
    x:(x-y)*32,
    y:(x+y)*16
  };
}

const MAP_RADIUS = 6;

for(let x=-MAP_RADIUS;x<=MAP_RADIUS;x++){
  for(let y=-MAP_RADIUS;y<=MAP_RADIUS;y++){

    if(Math.abs(x)+Math.abs(y)<MAP_RADIUS+2){

      const pos = cartToIso(x,y);

      const tile = new PIXI.Graphics();
      tile.beginFill(0x0d0022,0.8);
      tile.drawPolygon([0,0,32,16,0,32,-32,16]);
      tile.endFill();

      tile.position.set(
        pos.x + app.screen.width/2,
        pos.y + 250
      );

      groundLayer.addChild(tile);
    }
  }
}

// ================= PLAYER =================
const player = PIXI.Sprite.from("./assets/ship.png");
player.anchor.set(0.5);
player.scale.set(0.25);
player.position.set(app.screen.width/2, 300);
player.blendMode = PIXI.BLEND_MODES.ADD;
buildingLayer.addChild(player);

// ================= SPEED CONTROL =================
const speedKeyboard = 6;
const speedJoystick = 6;

// ================= KEYBOARD =================
const keys = {};

window.addEventListener("keydown", e=> keys[e.code]=true);
window.addEventListener("keyup", e=> keys[e.code]=false);
window.addEventListener("blur", ()=>{
  for(let k in keys) keys[k]=false;
});

// ================= JOYSTICK =================
const joystick = new PIXI.Container();
app.stage.addChild(joystick);

const base = new PIXI.Graphics();
base.beginFill(0x00ffff,0.2);
base.drawCircle(0,0,60);
base.endFill();
joystick.addChild(base);

const stick = new PIXI.Graphics();
stick.beginFill(0x00ffff,0.6);
stick.drawCircle(0,0,30);
stick.endFill();
joystick.addChild(stick);

function updateJoystickPosition(){
  joystick.position.set(100, app.screen.height - 100);
}

updateJoystickPosition();
joystick.alpha = 0.8;

let pointerId = null;
let moveVector = {x:0,y:0};

app.stage.eventMode = "static";
app.stage.hitArea = app.screen;

app.stage.on("pointerdown", e=>{
  if(pointerId===null && e.global.x < app.screen.width/2){
    pointerId = e.pointerId;
    updateJoystick(e.global);
  }
});

app.stage.on("pointermove", e=>{
  if(e.pointerId===pointerId){
    updateJoystick(e.global);
  }
});

app.stage.on("pointerup", e=>{
  if(e.pointerId===pointerId){
    resetJoystick();
  }
});

app.stage.on("pointerupoutside", e=>{
  if(e.pointerId===pointerId){
    resetJoystick();
  }
});

function updateJoystick(pos){
  const dx = pos.x - joystick.x;
  const dy = pos.y - joystick.y;
  const dist = Math.sqrt(dx*dx + dy*dy);
  const maxDist = 60;

  if(dist > maxDist){
    const angle = Math.atan2(dy,dx);
    stick.x = Math.cos(angle) * maxDist;
    stick.y = Math.sin(angle) * maxDist;
  }else{
    stick.x = dx;
    stick.y = dy;
  }

  moveVector.x = stick.x / maxDist;
  moveVector.y = stick.y / maxDist;
}

function resetJoystick(){
  pointerId = null;
  stick.x = 0;
  stick.y = 0;
  moveVector.x = 0;
  moveVector.y = 0;
}

// ================= RAIN (MULTI LAYER) =================
const rainDrops = [];

function createRainLayer(count, speedMin, speedMax, width, height, alpha){

  for(let i=0;i<count;i++){

    const drop = new PIXI.Graphics();
    drop.beginFill(0x00ffff, alpha);
    drop.drawRect(0,0,width,height);
    drop.endFill();

    drop.x = Math.random() * app.screen.width;
    drop.y = Math.random() * app.screen.height;
    drop.speed = Math.random() * (speedMax - speedMin) + speedMin;

    rainLayer.addChild(drop);
    rainDrops.push(drop);
  }
}

// Longe
createRainLayer(120, 1, 2, 1, 8, 0.3);

// Médio
createRainLayer(80, 2, 4, 2, 10, 0.6);

// Próximo
createRainLayer(50, 4, 7, 2, 14, 0.9);

// ================= RESIZE =================
window.addEventListener("resize", ()=>{
  app.stage.hitArea = app.screen;
  updateJoystickPosition();
  updateSkyline();
});

// ================= GAME LOOP =================
app.ticker.add(delta=>{

  let nx=player.x;
  let ny=player.y;

  // TECLADO
  if(keys["ArrowUp"] || keys["KeyW"]) ny -= speedKeyboard;
  if(keys["ArrowDown"] || keys["KeyS"]) ny += speedKeyboard;
  if(keys["ArrowLeft"] || keys["KeyA"]) nx -= speedKeyboard;
  if(keys["ArrowRight"] || keys["KeyD"]) nx += speedKeyboard;

  // JOYSTICK
  nx += moveVector.x * speedJoystick;
  ny += moveVector.y * speedJoystick;

  player.x = nx;
  player.y = ny;

  buildingLayer.children.sort((a,b)=>a.y-b.y);

  const targetX=-player.x+app.screen.width/2;
  const targetY=-player.y+app.screen.height/2;

  camera.x+=(targetX-camera.x)*0.08;
  camera.y+=(targetY-camera.y)*0.08;

  skyline.x = app.screen.width/2 + camera.x*0.05;
  skyline.y = app.screen.height/2 + camera.y*0.05;

  rainDrops.forEach(d=>{
    d.y += d.speed * delta;

    if(d.y > app.screen.height){
      d.y = -20;
      d.x = Math.random() * app.screen.width;
    }
  });

});

})();
</script>
</body>
</html>
