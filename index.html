<!doctype html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Neon Abyss</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.3/pixi.min.js"></script>
<style>
body {
  margin:0;
  overflow:hidden;
  background:#000;
}
canvas {
  display:block;
}
</style>
</head>
<body>
<script>

// =====================================================
// APP
// =====================================================
const app = new PIXI.Application({
  resizeTo: window,
  backgroundAlpha: 0,
  antialias: true
});
document.body.appendChild(app.view);

// =====================================================
// FUNDO ESTILIZADO
// =====================================================
const bg = new PIXI.Graphics();
bg.beginFill(0x070021);
bg.drawRect(0,0,app.screen.width,app.screen.height);
bg.endFill();
app.stage.addChild(bg);

// estrelas
for(let i=0;i<150;i++){
  const star = new PIXI.Graphics();
  star.beginFill(0x1a1a55);
  star.drawCircle(0,0,1.5);
  star.endFill();
  star.x = Math.random()*app.screen.width;
  star.y = Math.random()*app.screen.height;
  bg.addChild(star);
}

// =====================================================
// CAMERA + LAYERS
// =====================================================
const camera = new PIXI.Container();
app.stage.addChild(camera);

const groundLayer = new PIXI.Container();
const buildingLayer = new PIXI.Container();
const rainLayer = new PIXI.Container();

buildingLayer.sortableChildren = true;

camera.addChild(groundLayer);
camera.addChild(buildingLayer);
camera.addChild(rainLayer);

// =====================================================
// ISO FUNCTION
// =====================================================
function cartToIso(x,y){
  return {
    x:(x-y)*32,
    y:(x+y)*16
  };
}

// =====================================================
// MAP + BUILDINGS
// =====================================================
const MAP_RADIUS = 6;
const buildings = [];

for(let x=-MAP_RADIUS;x<=MAP_RADIUS;x++){
  for(let y=-MAP_RADIUS;y<=MAP_RADIUS;y++){

    if(Math.abs(x)+Math.abs(y)<MAP_RADIUS+2){

      const pos = cartToIso(x,y);

      // chão
      const tile = new PIXI.Graphics();
      tile.beginFill(0x0d0022);
      tile.drawPolygon([
        0,0,
        32,16,
        0,32,
        -32,16
      ]);
      tile.endFill();

      tile.position.set(
        pos.x + app.screen.width/2,
        pos.y + 200
      );

      groundLayer.addChild(tile);

      // prédio aleatório
      if(Math.random() > 0.6){

        const building = new PIXI.Container();

        const body = new PIXI.Graphics();
        body.beginFill(0x160033);
        body.drawRect(-20,-80,40,80);
        body.endFill();

        const outline = new PIXI.Graphics();
        outline.lineStyle(2,0x00ffff,0.8);
        outline.drawRect(-20,-80,40,80);

        building.addChild(body);
        building.addChild(outline);

        building.position.set(tile.x, tile.y);

        buildingLayer.addChild(building);
        buildings.push(building);

        // glow animado
        app.ticker.add(()=>{
          outline.alpha = 0.6 + Math.sin(Date.now()*0.004)*0.4;
        });
      }
    }
  }
}

// =====================================================
// PLAYER (USA /assets/ship.png)
// =====================================================
const shipTexture = PIXI.Texture.from("./assets/ship.png");

const player = new PIXI.Sprite(shipTexture);
player.anchor.set(0.5);
player.scale.set(0.25); // nave menor
player.blendMode = PIXI.BLEND_MODES.ADD;
player.position.set(app.screen.width/2, 300);

buildingLayer.addChild(player);

// =====================================================
// INPUT
// =====================================================
const keys = {};
window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

// =====================================================
// COLLISION SIMPLES
// =====================================================
function checkCollision(nx, ny){
  for(const b of buildings){
    const dx = nx - b.x;
    const dy = ny - (b.y-40);
    if(Math.abs(dx) < 25 && Math.abs(dy) < 40){
      return true;
    }
  }
  return false;
}

// =====================================================
// RAIN
// =====================================================
const rainDrops = [];

for(let i=0;i<250;i++){
  const drop = new PIXI.Graphics();
  drop.beginFill(0x00ffff);
  drop.drawRect(0,0,2,10);
  drop.endFill();

  drop.x = Math.random()*app.screen.width;
  drop.y = Math.random()*app.screen.height;
  drop.speed = Math.random()*4+2;

  rainLayer.addChild(drop);
  rainDrops.push(drop);
}

// =====================================================
// GAME LOOP
// =====================================================
app.ticker.add(delta=>{

  // movimento
  let nx = player.x;
  let ny = player.y;

  if(keys["arrowup"]) ny -= 4;
  if(keys["arrowdown"]) ny += 4;
  if(keys["arrowleft"]) nx -= 4;
  if(keys["arrowright"]) nx += 4;

  if(!checkCollision(nx,ny)){
    player.x = nx;
    player.y = ny;
  }

  // depth real
  buildingLayer.children.sort((a,b)=>a.y-b.y);

  // chuva
  rainDrops.forEach(d=>{
    d.y += d.speed*delta;
    if(d.y > app.screen.height){
      d.y = -20;
      d.x = Math.random()*app.screen.width;
    }
  });

  // câmera suave
  const targetX = -player.x + app.screen.width/2;
  const targetY = -player.y + app.screen.height/2;

  camera.x += (targetX - camera.x) * 0.07;
  camera.y += (targetY - camera.y) * 0.07;

});

console.log("Neon Abyss Git Ready rodando.");

</script>
</body>
</html>
