<!doctype html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Neon Abyss</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.3/pixi.min.js"></script>

<style>
body{
  margin:0;
  overflow:hidden;
  background:#000;
  touch-action:none;
}
canvas{ display:block; }
</style>
</head>
<body>

<script>
(async () => {

const app = new PIXI.Application({
  resizeTo: window,
  backgroundColor: 0x000000,
  antialias: true
});
document.body.appendChild(app.view);

// ================= PRELOAD =================
await PIXI.Assets.load([
  "./assets/station_bg.png",
  "./assets/ship.png"
]);

// ================= FUNDO =================
const skyline = PIXI.Sprite.from("./assets/station_bg.png");
skyline.anchor.set(0.5);
skyline.position.set(app.screen.width/2, app.screen.height/2);

const scale = Math.max(
  app.screen.width / skyline.texture.width,
  app.screen.height / skyline.texture.height
);
skyline.scale.set(scale);
skyline.alpha = 0.6;
app.stage.addChild(skyline);

// ================= CAMERA =================
const camera = new PIXI.Container();
app.stage.addChild(camera);

const groundLayer = new PIXI.Container();
const buildingLayer = new PIXI.Container();
buildingLayer.sortableChildren = true;

camera.addChild(groundLayer);
camera.addChild(buildingLayer);

// ================= ISO MAP =================
function cartToIso(x,y){
  return {
    x:(x-y)*32,
    y:(x+y)*16
  };
}

const MAP_RADIUS = 6;

for(let x=-MAP_RADIUS;x<=MAP_RADIUS;x++){
  for(let y=-MAP_RADIUS;y<=MAP_RADIUS;y++){

    if(Math.abs(x)+Math.abs(y)<MAP_RADIUS+2){

      const pos = cartToIso(x,y);

      const tile = new PIXI.Graphics();
      tile.beginFill(0x0d0022,0.8);
      tile.drawPolygon([0,0,32,16,0,32,-32,16]);
      tile.endFill();

      tile.position.set(
        pos.x + app.screen.width/2,
        pos.y + 250
      );

      groundLayer.addChild(tile);
    }
  }
}

// ================= PLAYER =================
const player = PIXI.Sprite.from("./assets/ship.png");
player.anchor.set(0.5);
player.scale.set(0.25);
player.position.set(app.screen.width/2, 300);
player.blendMode = PIXI.BLEND_MODES.ADD;

buildingLayer.addChild(player);

// ================= TECLADO =================
const keys = {};

window.addEventListener("keydown", e=>{
  keys[e.code] = true;
});

window.addEventListener("keyup", e=>{
  keys[e.code] = false;
});

window.addEventListener("blur", ()=>{
  for(let k in keys) keys[k] = false;
});

// ================= JOYSTICK VISUAL =================
const joystickBase = new PIXI.Graphics();
joystickBase.beginFill(0x00ffff,0.2);
joystickBase.drawCircle(0,0,60);
joystickBase.endFill();
joystickBase.visible = false;
app.stage.addChild(joystickBase);

const joystickKnob = new PIXI.Graphics();
joystickKnob.beginFill(0x00ffff,0.6);
joystickKnob.drawCircle(0,0,30);
joystickKnob.endFill();
joystickKnob.visible = false;
app.stage.addChild(joystickKnob);

let pointerActive = false;
let joystickCenter = {x:0,y:0};
let moveVector = {x:0,y:0};

app.stage.eventMode = "static";
app.stage.hitArea = app.screen;

app.stage.on("pointerdown", e=>{
  pointerActive = true;
  joystickCenter = e.global;

  joystickBase.position.copyFrom(joystickCenter);
  joystickKnob.position.copyFrom(joystickCenter);

  joystickBase.visible = true;
  joystickKnob.visible = true;
});

app.stage.on("pointermove", e=>{
  if(!pointerActive) return;

  const dx = e.global.x - joystickCenter.x;
  const dy = e.global.y - joystickCenter.y;
  const dist = Math.sqrt(dx*dx + dy*dy);
  const maxDist = 60;

  let angle = Math.atan2(dy, dx);

  let limitedDist = Math.min(dist, maxDist);

  joystickKnob.x = joystickCenter.x + Math.cos(angle)*limitedDist;
  joystickKnob.y = joystickCenter.y + Math.sin(angle)*limitedDist;

  moveVector.x = Math.cos(angle) * (limitedDist/maxDist);
  moveVector.y = Math.sin(angle) * (limitedDist/maxDist);
});

app.stage.on("pointerup", resetJoystick);
app.stage.on("pointerupoutside", resetJoystick);

function resetJoystick(){
  pointerActive = false;
  moveVector.x = 0;
  moveVector.y = 0;
  joystickBase.visible = false;
  joystickKnob.visible = false;
}

// ================= GAME LOOP =================
app.ticker.add(delta=>{

  let nx=player.x;
  let ny=player.y;

  const speed=6;

  // teclado
  if(keys["ArrowUp"] || keys["KeyW"]) ny -= speed;
  if(keys["ArrowDown"] || keys["KeyS"]) ny += speed;
  if(keys["ArrowLeft"] || keys["KeyA"]) nx -= speed;
  if(keys["ArrowRight"] || keys["KeyD"]) nx += speed;

  // joystick mobile
  if(pointerActive){
    nx += moveVector.x * speed * 1.2;
    ny += moveVector.y * speed * 1.2;
  }

  // suavizaÃ§Ã£o
  player.x += (nx - player.x) * 0.35;
  player.y += (ny - player.y) * 0.35;

  buildingLayer.children.sort((a,b)=>a.y-b.y);

  const targetX=-player.x+app.screen.width/2;
  const targetY=-player.y+app.screen.height/2;

  camera.x+=(targetX-camera.x)*0.08;
  camera.y+=(targetY-camera.y)*0.08;

});

console.log("Neon Abyss - Mobile AAA Build ðŸš€");

})();
</script>
</body>
</html>
