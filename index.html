<!doctype html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Neon Abyss</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.3/pixi.min.js"></script>
<style>
body{
  margin:0;
  overflow:hidden;
  background:#000;
  touch-action:none;
}
canvas{ display:block; }
</style>
</head>
<body>
<script>

// =====================================================
// APP
// =====================================================
const app = new PIXI.Application({
  resizeTo: window,
  backgroundAlpha: 0,
  antialias: true
});
document.body.appendChild(app.view);

// =====================================================
// SKYLINE CINEMATOGRÁFICO
// =====================================================
const skylineTexture = PIXI.Texture.from("./assets/station_bg.png");
const skyline = new PIXI.Sprite(skylineTexture);

skyline.anchor.set(0.5);
skyline.position.set(app.screen.width/2, app.screen.height/2);

const scaleX = app.screen.width / skyline.width;
const scaleY = app.screen.height / skyline.height;
skyline.scale.set(Math.max(scaleX, scaleY));

skyline.alpha = 0.6;

app.stage.addChild(skyline);

// =====================================================
// CAMERA + LAYERS
// =====================================================
const camera = new PIXI.Container();
app.stage.addChild(camera);

const groundLayer = new PIXI.Container();
const buildingLayer = new PIXI.Container();
const rainLayer = new PIXI.Container();

buildingLayer.sortableChildren = true;

camera.addChild(groundLayer);
camera.addChild(buildingLayer);
app.stage.addChild(rainLayer); // chuva sempre na frente

// =====================================================
// ISO FUNCTION
// =====================================================
function cartToIso(x,y){
  return {
    x:(x-y)*32,
    y:(x+y)*16
  };
}

// =====================================================
// MAPA
// =====================================================
const MAP_RADIUS = 6;
const buildings = [];

for(let x=-MAP_RADIUS;x<=MAP_RADIUS;x++){
  for(let y=-MAP_RADIUS;y<=MAP_RADIUS;y++){

    if(Math.abs(x)+Math.abs(y)<MAP_RADIUS+2){

      const pos = cartToIso(x,y);

      const tile = new PIXI.Graphics();
      tile.beginFill(0x0d0022,0.8);
      tile.drawPolygon([
        0,0,
        32,16,
        0,32,
        -32,16
      ]);
      tile.endFill();

      tile.position.set(
        pos.x + app.screen.width/2,
        pos.y + 250
      );

      groundLayer.addChild(tile);

      // prédios simples
      if(Math.random()>0.65){

        const building = new PIXI.Container();

        const body = new PIXI.Graphics();
        body.beginFill(0x160033);
        body.drawRect(-20,-70,40,70);
        body.endFill();

        const outline = new PIXI.Graphics();
        outline.lineStyle(2,0x00ffff,0.8);
        outline.drawRect(-20,-70,40,70);

        building.addChild(body);
        building.addChild(outline);

        building.position.set(tile.x, tile.y);

        buildingLayer.addChild(building);
        buildings.push(building);

        app.ticker.add(()=>{
          outline.alpha = 0.6 + Math.sin(Date.now()*0.004)*0.4;
        });
      }
    }
  }
}

// =====================================================
// PLAYER
// =====================================================
const shipTexture = PIXI.Texture.from("./assets/ship.png");
const player = new PIXI.Sprite(shipTexture);

player.anchor.set(0.5);
player.scale.set(0.25);
player.blendMode = PIXI.BLEND_MODES.ADD;
player.position.set(app.screen.width/2, 300);

buildingLayer.addChild(player);

// =====================================================
// HINT UI
// =====================================================
const hint = new PIXI.Text(
"Toque na tela ou use as setas para mover",
{
  fill:"#00ffff",
  fontSize:18,
  fontWeight:"bold"
});

hint.anchor.set(0.5);
hint.position.set(app.screen.width/2, app.screen.height-60);
hint.alpha=0;

app.stage.addChild(hint);

let hintTime=0;
let hintVisible=true;

// =====================================================
// INPUT
// =====================================================
const keys={};
window.addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
window.addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

let touchActive=false;
let touchX=0;
let touchY=0;

app.view.addEventListener("touchstart",e=>{
  touchActive=true;
  touchX=e.touches[0].clientX;
  touchY=e.touches[0].clientY;
});
app.view.addEventListener("touchmove",e=>{
  touchX=e.touches[0].clientX;
  touchY=e.touches[0].clientY;
});
app.view.addEventListener("touchend",()=>touchActive=false);

// =====================================================
// COLLISION
// =====================================================
function checkCollision(nx,ny){
  for(const b of buildings){
    if(Math.abs(nx-b.x)<25 && Math.abs(ny-(b.y-35))<35){
      return true;
    }
  }
  return false;
}

// =====================================================
// CHUVA
// =====================================================
const rainDrops=[];
for(let i=0;i<250;i++){
  const drop=new PIXI.Graphics();
  drop.beginFill(0x00ffff);
  drop.drawRect(0,0,2,10);
  drop.endFill();
  drop.x=Math.random()*app.screen.width;
  drop.y=Math.random()*app.screen.height;
  drop.speed=Math.random()*4+2;
  rainLayer.addChild(drop);
  rainDrops.push(drop);
}

// =====================================================
// GAME LOOP
// =====================================================
app.ticker.add(delta=>{

  let nx=player.x;
  let ny=player.y;
  const speed=4;

  if(keys["arrowup"])ny-=speed;
  if(keys["arrowdown"])ny+=speed;
  if(keys["arrowleft"])nx-=speed;
  if(keys["arrowright"])nx+=speed;

  if(touchActive){
    const dx=touchX-app.screen.width/2;
    const dy=touchY-app.screen.height/2;
    const dist=Math.sqrt(dx*dx+dy*dy);
    if(dist>20){
      const angle=Math.atan2(dy,dx);
      nx+=Math.cos(angle)*speed;
      ny+=Math.sin(angle)*speed;
    }
  }

  if(!checkCollision(nx,ny)){
    player.x=nx;
    player.y=ny;
  }

  // depth
  buildingLayer.children.sort((a,b)=>a.y-b.y);

  // skyline parallax
  skyline.x = app.screen.width/2 + camera.x*0.05;
  skyline.y = app.screen.height/2 + camera.y*0.05;

  // câmera
  const targetX=-player.x+app.screen.width/2;
  const targetY=-player.y+app.screen.height/2;

  camera.x+=(targetX-camera.x)*0.07;
  camera.y+=(targetY-camera.y)*0.07;

  // chuva
  rainDrops.forEach(d=>{
    d.y+=d.speed*delta;
    if(d.y>app.screen.height){
      d.y=-20;
      d.x=Math.random()*app.screen.width;
    }
  });

  // hint
  if(hintVisible){
    hintTime+=delta;
    if(hint.alpha<1 && hintTime<60)hint.alpha+=0.03;
    if(hintTime>300){
      hint.alpha-=0.03;
      if(hint.alpha<=0){
        hintVisible=false;
        hint.destroy();
      }
    }
  }

  if(hintVisible && (
    keys["arrowup"]||
    keys["arrowdown"]||
    keys["arrowleft"]||
    keys["arrowright"]||
    touchActive
  )){
    hintVisible=false;
    hint.destroy();
  }

});

console.log("Neon Abyss - Skyline Edition Ready");

</script>
</body>
</html>
